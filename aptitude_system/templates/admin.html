{% extends "base.html" %}

{% block title %}관리자 페이지 - 인적성 평가시스템{% endblock %}

{% block head %}
<style>
.question-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 10px;
    background-color: #f8f9fa;
}

.question-checkbox {
    margin-right: 8px;
}

.form-check-label {
    font-size: 0.875rem;
    line-height: 1.4;
}

.accordion-button {
    padding: 0.75rem 1rem;
    font-size: 0.9rem;
}

.accordion-body {
    padding: 1rem;
}

.badge {
    font-size: 0.7rem;
}

.modal-xl {
    max-width: 1200px;
}

#totalRandomCount, #editTotalRandomCount {
    background-color: #e9ecef;
    font-weight: bold;
}

#totalSelectedCount, #editTotalSelectedCount {
    color: #0d6efd;
    font-weight: bold;
}

.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.accordion-item {
    border: 1px solid #dee2e6;
    margin-bottom: 0.5rem;
}

.accordion-button:not(.collapsed) {
    background-color: #e7f1ff;
    color: #0d6efd;
}

.accordion-button:focus {
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}
</style>
{% endblock %}

{% block page_id %}
<div class="page-id" style="background:#f8f9fa; border-bottom:1px solid #dee2e6; padding:4px 12px; font-size:0.95em; color:#888;">
  화면ID: PAGE-ADMIN (admin.html)
</div>
{% endblock %}

{% block content %}
<!-- 지원자 추가 모달 -->
<div class="modal fade" id="addCandidateModal" tabindex="-1">
  <div class="modal-dialog" style="max-width:540px;">
    <div class="modal-content">
      <div class="page-id" style="background:#f8f9fa; border-bottom:1px solid #dee2e6; padding:4px 12px; font-size:0.95em; color:#888;">
        팝업ID: POPUP-ADD-CANDIDATE (admin.html)
      </div>
      <form id="addCandidateForm">
        <div class="modal-header">
          <h5 class="modal-title">지원자 사전등록</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">부서</label>
            <select name="department_id" class="form-select" required>
              <option value="">부서 선택</option>
              {% for dept in departments %}
              <option value="{{ dept.id }}">{{ dept.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">이름</label>
            <input type="text" name="name" class="form-control" required>
            <div class="form-text">지원자는 이름만 일치해야 입장 가능</div>
          </div>
          <div class="mb-3">
            <label class="form-label">접속 가능 날짜 (YYYY-MM-DD)</label>
            <input type="date" name="access_date" class="form-control" required>
            <div class="form-text">해당 날짜에만 시험 응시 가능</div>
          </div>
          <div class="mb-3">
            <label class="form-label">문제풀이 시간(분)</label>
            <input type="number" name="test_duration" class="form-control" min="1" value="10">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="submit" class="btn btn-success">등록</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 지원자 수정 모달 -->
<div class="modal fade" id="editCandidateModal" tabindex="-1">
  <div class="modal-dialog" style="max-width:540px;">
    <div class="modal-content">
      <div class="page-id" style="background:#f8f9fa; border-bottom:1px solid #dee2e6; padding:4px 12px; font-size:0.95em; color:#888;">
        팝업ID: POPUP-EDIT-CANDIDATE (admin.html)
      </div>
      <form id="editCandidateForm">
        <div class="modal-header">
          <h5 class="modal-title">지원자 정보 수정</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editCandidateId" name="candidate_id">
          <div class="mb-3">
            <label class="form-label">부서</label>
            <select id="editCandidateDepartment" name="department_id" class="form-select" required>
              <option value="">부서 선택</option>
              {% for dept in departments %}
              <option value="{{ dept.id }}">{{ dept.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">이름</label>
            <input type="text" id="editCandidateName" name="name" class="form-control" required>
            <div class="form-text">지원자는 이름만 일치해야 입장 가능</div>
          </div>
          <div class="mb-3">
            <label class="form-label">접속 가능 날짜 (YYYY-MM-DD)</label>
            <input type="date" id="editCandidateAccessDate" name="access_date" class="form-control" required>
            <div class="form-text">해당 날짜에만 시험 응시 가능</div>
          </div>
          <div class="mb-3">
            <label class="form-label">문제풀이 시간(분)</label>
            <input type="number" id="editCandidateTestDuration" name="test_duration" class="form-control" min="1">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="submit" class="btn btn-primary">수정</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 회사 정보 설정 모달, form(id='companySettingsForm'), 회사명/설명/로고 input, 파일 업로드, submit 이벤트 JS 등 회사 정보/로고 관련 모든 UI 및 JS 코드 완전 삭제 -->

<!-- 탭 네비게이션 -->
<ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">
      <i class="fas fa-chart-bar"></i> 대시보드
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
      <i class="fas fa-cog"></i> 시스템 설정
    </button>
  </li>
</ul>

<!-- 탭 콘텐츠 -->
<div class="tab-content" id="adminTabContent">
  <!-- 대시보드 탭 -->
  <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
    <!-- 기존 관리자 페이지 내용 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h3 class="card-title mb-4">
                        <i class="fas fa-chart-bar"></i> 관리자 대시보드
                    </h3>
                    
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">총 지원자</h5>
                                    <h3 class="mb-0">{{ candidates|length }}명</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">평가 완료</h5>
                                    <h3 class="mb-0">{{ candidate_results|length }}명</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-dark">
                                <div class="card-body text-center">
                                    <h5 class="card-title">평가 미완료</h5>
                                    <h3 class="mb-0">{{ candidates|length - candidate_results|length }}명</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">평균 점수</h5>
                                    <h3 class="mb-0">
                                        {# 평가 결과가 있을 때만 평균 계산, 없으면 0점 #}
                                        {% if candidate_results and candidate_results|length > 0 %}
                                            {{ "%.1f"|format(candidate_results.values()|map(attribute='result.total_score')|sum / candidate_results|length) }}점
                                        {% else %}
                                            0점
                                        {% endif %}
                                    </h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title mb-4">
                        <i class="fas fa-list"></i> 지원자 목록 및 평가 결과
                    </h4>
                    
                    <!-- 관리 기능 버튼 -->
                    <div class="mb-3">
                        <a href="{{ url_for('question_manage') }}" class="btn btn-primary">
                            <i class="fas fa-question-circle"></i> 문제 관리
                        </a>
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addCandidateModal">
                            <i class="fas fa-user-plus"></i> 지원자 추가
                        </button>
                    </div>
                    
                    {% if candidates %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>순위</th>
                                    <th>이름</th>
                                    <th>이메일</th>
                                    <th>핸드폰번호</th>
                                    <th>부서</th>
                                    <th>접속가능일</th>
                                    <th>상태</th>
                                    <th>총점</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for c in candidates %}
                                <tr data-candidate-id="{{ c['id'] }}"
                                    data-name="{{ c['name'] }}"
                                    data-access-date="{{ c['access_date'] }}"
                                    data-test-duration="{{ c['test_duration'] }}"
                                    data-department-id="{{ c['department_id'] or '' }}">
                                    <td>{{ loop.index }}</td>
                                    <td>{{ c['name'] }}</td>
                                    <td>{{ c['email'] or '미입력' }}</td>
                                    <td>{{ c['phone'] or '미입력' }}</td>
                                    <td>
  <b>
    {{
      departments
      | selectattr('id', 'equalto', c['department_id'])
      | map(attribute='name')
      | list
      | first
      or '미지정'
    }}
  </b>
</td>
                                    <td>{{ c['created_at_formatted'] }}</td>
                                    <td>
                                        {% if candidate_results[c['id']] %}
                                            <span class="badge bg-success">평가완료</span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">미완료</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ candidate_results[c['id']].total_score if candidate_results[c['id']] else 'N/A' }}</td>
                                    <td>
                                        {% if candidate_results[c['id']] %}
                                            <button class="btn btn-sm btn-outline-secondary" disabled title="평가완료된 지원자는 수정할 수 없습니다">
                                                <i class="fas fa-edit"></i> 수정
                                            </button>
                                        {% else %}
                                            <button class="btn btn-sm btn-outline-primary edit-candidate-btn">
                                                <i class="fas fa-edit"></i> 수정
                                            </button>
                                        {% endif %}
                                        <button class="btn btn-sm btn-outline-danger delete-candidate-btn">
                                            <i class="fas fa-trash"></i> 삭제
                                        </button>
                                        {% if candidate_results[c['id']] %}
                                        <a href="{{ url_for('admin_answer_detail', candidate_id=c['id']) }}" class="btn btn-sm btn-outline-info">
                                            <i class="fas fa-file-alt"></i> 결과
                                        </a>
                                        {% endif %}

                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">등록된 지원자가 없습니다.</h5>
                        <p class="text-muted">지원자가 등록되면 여기에 표시됩니다.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if candidate_results %}
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-trophy"></i> 상위 5명
                    </h5>
                    <div class="list-group">
                        {% for candidate_id, data in candidate_results.items() %}
                        {% if data.result.rank <= 5 %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ data.result.rank }}위</strong> - {{ data.candidate.name }}
                                <br><small class="text-muted">{{ data.candidate.email }}</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">{{ data.result.total_score }}점</span>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-chart-pie"></i> 점수 분포
                    </h5>
                    <div class="row text-center">
                        <div class="col-3">
                            <h4 class="text-success">
                                {% set excellent = candidate_results.values()|selectattr('result.total_score', '>=', 150)|list|length %}
                                {{ excellent }}
                            </h4>
                            <small class="text-muted">우수<br>(150점↑)</small>
                        </div>
                        <div class="col-3">
                            <h4 class="text-info">
                                {% set good = candidate_results.values()|selectattr('result.total_score', '>=', 120)|selectattr('result.total_score', '<', 150)|list|length %}
                                {{ good }}
                            </h4>
                            <small class="text-muted">양호<br>(120-149점)</small>
                        </div>
                        <div class="col-3">
                            <h4 class="text-warning">
                                {% set normal = candidate_results.values()|selectattr('result.total_score', '>=', 90)|selectattr('result.total_score', '<', 120)|list|length %}
                                {{ normal }}
                            </h4>
                            <small class="text-muted">보통<br>(90-119점)</small>
                        </div>
                        <div class="col-3">
                            <h4 class="text-danger">
                                {% set poor = candidate_results.values()|selectattr('result.total_score', '<', 90)|list|length %}
                                {{ poor }}
                            </h4>
                            <small class="text-muted">개선 필요<br>(90점↓)</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
  </div>

  <!-- 시스템 설정 탭 -->
  <div class="tab-pane fade" id="settings" role="tabpanel">
    <div class="row">
      <!-- 부서 관리 -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">부서 관리</h5>
          </div>
          <div class="card-body">
            <form id="addDepartmentForm" class="mb-3">
              <div class="input-group mb-2">
                <input type="text" name="name" class="form-control" placeholder="새 부서명 입력" required>
                <button class="btn btn-primary" type="submit">추가</button>
              </div>
            </form>
            <!-- 등록된 부서 목록 테이블 -->
            <table class="table table-bordered table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th style="width:60px;">#</th>
                  <th>부서명</th>
                  <th style="width:180px;">관리</th>
                </tr>
              </thead>
              <tbody>
                {% for dept in departments %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td>{{ dept.name }}</td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary assign-questions-btn" data-id="{{ dept.id }}" data-name="{{ dept.name }}">문제할당</button>
                    <button class="btn btn-sm btn-outline-danger delete-department-btn" data-id="{{ dept.id }}">삭제</button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            <div class="form-text text-danger mt-2">부서 삭제 시 해당 부서에 매핑된 문제들은 '미지정' 상태로 남습니다.</div>
          </div>
        </div>
      </div>
      <!-- 문제-지원자 매칭 링크 -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">문제-지원자 관리</h5>
          </div>
          <div class="card-body">
            <p>지원자별로 시험 볼 문제를 직접 선택하고 할당합니다.</p>
            <a href="{{ url_for('candidate_question_match') }}" class="btn btn-primary">
              <i class="fas fa-link"></i> 매칭 페이지로 이동
            </a>
          </div>
        </div>
      </div>
    </div>
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title"><i class="fas fa-random"></i> 랜덤 출제 개수 설정</h5>
        <form id="randomConfigForm" class="row g-3 align-items-end">
          <!-- Java 카테고리 -->
          <div class="col-md-2">
            <label for="javaMcCountInput" class="form-label mb-1">Java 객관식</label>
            <input type="number" id="javaMcCountInput" name="java_mc_count" class="form-control" min="0" value="2" style="width:100%;">
          </div>
          <div class="col-md-2">
            <label for="javaSubCountInput" class="form-label mb-1">Java 주관식</label>
            <input type="number" id="javaSubCountInput" name="java_sub_count" class="form-control" min="0" value="1" style="width:100%;">
          </div>
          <!-- Database 카테고리 -->
          <div class="col-md-2">
            <label for="dbMcCountInput" class="form-label mb-1">Database 객관식</label>
            <input type="number" id="dbMcCountInput" name="db_mc_count" class="form-control" min="0" value="3" style="width:100%;">
          </div>
          <div class="col-md-2">
            <label for="dbSubCountInput" class="form-label mb-1">Database 주관식</label>
            <input type="number" id="dbSubCountInput" name="db_sub_count" class="form-control" min="0" value="1" style="width:100%;">
          </div>
          <!-- 문제해결 카테고리 -->
          <div class="col-md-2">
            <label for="psMcCountInput" class="form-label mb-1">문제해결 객관식</label>
            <input type="number" id="psMcCountInput" name="ps_mc_count" class="form-control" min="0" value="3" style="width:100%;">
          </div>
          <div class="col-md-2 d-flex flex-column justify-content-end">
            <button type="submit" class="btn btn-primary">저장</button>
            <div class="mt-1" id="randomConfigMsg"></div>
          </div>
        </form>
      </div>
    </div>
    <div class="d-flex justify-content-end align-items-center mb-3">
      <button class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#openaiKeyModal">
        <i class="fas fa-key"></i> OpenAI API Key 설정
      </button>
    </div>
  </div>
</div>

<!-- 문제 할당 모달 -->
<div class="modal fade" id="assignQuestionsModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><span id="assignDeptName"></span> - 문제 할당 (POPUP-ASSIGN-QUESTIONS)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- 조회된 문제 개수 표시 -->
        <div class="mb-2 text-end">
          <span class="badge bg-primary" id="assignQuestionsCount">조회된 문제: 0개</span>
        </div>
        <!-- 필터 영역 -->
        <div class="row mb-3">
          <div class="col-md-3">
            <select id="filterDepartment" class="form-select form-select-sm">
              <option value="">전체 부서</option>
              <option value="current" id="currentDeptOption">현재 부서: <span id="currentDeptName"></span></option>
              <option value="unassigned">미지정</option>
            </select>
          </div>
          <div class="col-md-2">
            <select id="filterType" class="form-select form-select-sm">
              <option value="">전체 유형</option>
              <option value="객관식">객관식</option>
              <option value="주관식">주관식</option>
            </select>
          </div>
          <div class="col-md-2">
            <select id="filterCategory" class="form-select form-select-sm">
              <option value="">전체 카테고리</option>
              <option value="Java">Java</option>
              <option value="Database">Database</option>
              <option value="문제해결">문제해결</option>
            </select>
          </div>
          <div class="col-md-5 text-end">
            <button class="btn btn-outline-secondary btn-sm" id="selectAllQuestions">전체선택</button>
            <button class="btn btn-outline-secondary btn-sm" id="deselectAllQuestions">전체해제</button>
          </div>
        </div>
        <!-- 문제 목록 -->
        <div class="question-list border rounded p-2" style="max-height:400px; overflow-y:auto; background:#f8f9fa;">
          <form id="assignQuestionsForm">
            <input type="hidden" name="department_id" id="assignDeptId">
            <div id="assignQuestionsContainer">
              <!-- JS로 문제 체크박스 렌더링 -->
            </div>
          </form>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
        <button type="button" class="btn btn-primary" id="saveAssignQuestionsBtn">저장</button>
      </div>
    </div>
  </div>
</div>



<!-- OpenAI API Key 설정 모달 -->
<div class="modal fade" id="openaiKeyModal" tabindex="-1">
  <div class="modal-dialog" style="max-width:480px;">
    <div class="modal-content">
      <form id="openaiKeyForm">
        <div class="modal-header">
          <h5 class="modal-title">OpenAI API Key 설정</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">API Key</label>
            <input type="text" name="openai_api_key" id="openaiApiKeyInput" class="form-control" placeholder="sk-..." required>
            <div class="form-text">OpenAI에서 발급받은 API Key를 입력하세요. (저장 시 서버에 반영)</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="submit" class="btn btn-primary">저장</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="text-center mt-4">
    <a href="{{ url_for('index') }}" class="btn btn-primary">
        <i class="fas fa-home"></i> 메인으로 돌아가기
    </a>
    <button onclick="window.print()" class="btn btn-secondary">
        <i class="fas fa-print"></i> 결과 출력
    </button>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 지원자 추가 폼 제출
    document.getElementById('addCandidateForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());

        fetch('{{ url_for("add_candidate") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('지원자가 성공적으로 등록되었습니다.');
                window.location.reload();
            } else {
                alert('지원자 등록 실패: ' + result.message);
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('지원자 등록 중 오류가 발생했습니다.');
        });
    });

    // 수정 버튼 클릭 시 모달 열기 및 데이터 채우기
    const editModal = new bootstrap.Modal(document.getElementById('editCandidateModal'));
    document.querySelectorAll('.edit-candidate-btn').forEach(button => {
        button.addEventListener('click', function() {
            const row = this.closest('tr');
            document.getElementById('editCandidateId').value = row.dataset.candidateId;
            document.getElementById('editCandidateName').value = row.dataset.name;
            document.getElementById('editCandidateAccessDate').value = row.dataset.accessDate;
            document.getElementById('editCandidateTestDuration').value = row.dataset.testDuration;
            document.getElementById('editCandidateDepartment').value = row.dataset.departmentId;
            editModal.show();
        });
    });

    // 지원자 수정 폼 제출
    document.getElementById('editCandidateForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        const candidateId = data.candidate_id;

        fetch(`/admin/candidate/edit/${candidateId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('지원자 정보가 수정되었습니다.');
                window.location.reload();
            } else {
                alert('수정 실패: ' + result.message);
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('수정 중 오류가 발생했습니다.');
        });
    });

    // 지원자 삭제 기능
    document.querySelectorAll('.delete-candidate-btn').forEach(button => {
        button.addEventListener('click', function() {
            const row = this.closest('tr');
            const candidateId = row.dataset.candidateId;
            const candidateName = row.dataset.name;

            if (confirm(`'${candidateName}' 지원자를 정말로 삭제하시겠습니까? 관련 데이터가 모두 삭제됩니다.`)) {
                fetch(`/admin/candidate/delete/${candidateId}`, {
                    method: 'DELETE',
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('지원자가 삭제되었습니다.');
                        window.location.reload();
                    } else {
                        alert('삭제 실패: ' + result.message);
                    }
                }).catch(error => {
                    console.error('Error:', error);
                    alert('삭제 중 오류가 발생했습니다.');
                });
            }
        });
    });

    // 부서 추가 폼 제출
    document.getElementById('addDepartmentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const departmentName = this.querySelector('input[name="name"]').value.trim();
        if (!departmentName) {
            alert('부서명을 입력해주세요.');
            return;
        }

        fetch('/admin/departments/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name: departmentName })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('부서가 추가되었습니다.');
                // 폼 초기화
                this.querySelector('input[name="name"]').value = '';
                // 부서 목록 업데이트
                updateDepartmentList();
            } else {
                alert('추가 실패: ' + result.message);
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('부서 추가 중 오류가 발생했습니다.');
        });
    });

    // 부서 목록 업데이트 함수
    function updateDepartmentList() {
        fetch('/api/departments')
            .then(response => response.json())
            .then(data => {
                const tbody = document.querySelector('#addDepartmentForm').closest('.card-body').querySelector('table tbody');
                tbody.innerHTML = '';
                
                // departments 배열이 data.departments에 있는지 확인
                const departments = data.departments || data;
                
                departments.forEach((dept, index) => {
                    const row = `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${dept.name || '부서명 없음'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary assign-questions-btn" data-id="${dept.id}" data-name="${dept.name || '부서명 없음'}">문제할당</button>
                                <button class="btn btn-sm btn-outline-danger delete-department-btn" data-id="${dept.id}" data-name="${dept.name || '부서명 없음'}">삭제</button>
                            </td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
                
                // 새로 추가된 삭제 버튼에 이벤트 리스너 다시 연결
                attachDeleteDepartmentListeners();
                // 새로 추가된 문제할당 버튼에 이벤트 리스너 다시 연결
                attachAssignQuestionsListeners();
                
                // 부서 필터 옵션 업데이트
                updateDepartmentFilterOptions(departments);
            })
            .catch(error => {
                console.error('부서 목록 업데이트 실패:', error);
            });
    }
    
    // 부서 필터 옵션 업데이트 함수 (일반용)
    function updateDepartmentFilterOptions(departments) {
        const filterDepartment = document.getElementById('filterDepartment');
        const currentOptions = filterDepartment.querySelectorAll('option');
        const currentDeptId = document.getElementById('assignDeptId').value;
        
        // 기존 부서 옵션들 제거 (전체 부서, 현재 부서, 미지정 제외)
        currentOptions.forEach((option, index) => {
            if (index > 2) { // 0: 전체 부서, 1: 현재 부서, 2: 미지정
                option.remove();
            }
        });
        
        // 새로운 부서 옵션들 추가 (현재 부서 제외)
        departments.forEach(dept => {
            // 현재 부서는 제외하고 추가
            if (dept.id !== currentDeptId) {
                const option = document.createElement('option');
                option.value = dept.id;
                option.textContent = dept.name || '부서명 없음';
                filterDepartment.appendChild(option);
            }
        });
    }
    
    // 부서 필터 옵션 업데이트 함수 (모달용)
    function updateDepartmentFilterOptionsForModal(currentDeptId) {
        const filterDepartment = document.getElementById('filterDepartment');
        const currentOptions = filterDepartment.querySelectorAll('option');
        
        // 기존 부서 옵션들 제거 (전체 부서, 현재 부서, 미지정 제외)
        currentOptions.forEach((option, index) => {
            if (index > 2) { // 0: 전체 부서, 1: 현재 부서, 2: 미지정
                option.remove();
            }
        });
        
        // 부서 목록을 가져와서 현재 부서를 제외하고 추가
        fetch('/api/departments')
            .then(response => response.json())
            .then(data => {
                const departments = data.departments || data;
                
                // 새로운 부서 옵션들 추가 (현재 부서 제외)
                departments.forEach(dept => {
                    // 현재 부서는 제외하고 추가
                    if (dept.id !== currentDeptId) {
                        const option = document.createElement('option');
                        option.value = dept.id;
                        option.textContent = dept.name || '부서명 없음';
                        filterDepartment.appendChild(option);
                    }
                });
            })
            .catch(error => {
                console.error('부서 목록 업데이트 실패:', error);
            });
    }

    // 부서 삭제 이벤트 리스너 연결 함수
    function attachDeleteDepartmentListeners() {
        document.querySelectorAll('.delete-department-btn').forEach(button => {
            button.addEventListener('click', function() {
                const departmentId = this.dataset.id;
                const departmentName = this.dataset.name || '알 수 없는 부서';

                if (confirm(`'${departmentName}' 부서를 정말로 삭제하시겠습니까? 해당 부서에 속한 문제들은 '미지정' 상태가 됩니다.`)) {
                    fetch(`/admin/departments/delete/${departmentId}`, {
                        method: 'DELETE',
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            alert('부서가 삭제되었습니다.');
                            updateDepartmentList();
                        } else {
                            alert('삭제 실패: ' + result.message);
                        }
                    }).catch(error => {
                        console.error('Error:', error);
                        alert('삭제 중 오류가 발생했습니다.');
                    });
                }
            });
        });
    }

    // 문제할당 버튼 이벤트 리스너 연결 함수
    function attachAssignQuestionsListeners() {
        document.querySelectorAll('.assign-questions-btn').forEach(button => {
            // 기존 이벤트 리스너 제거 (중복 방지)
            button.removeEventListener('click', handleAssignQuestionsClick);
            // 새로운 이벤트 리스너 추가
            button.addEventListener('click', handleAssignQuestionsClick);
        });
    }

    // 문제할당 버튼 클릭 핸들러
    function handleAssignQuestionsClick() {
        const departmentId = this.dataset.id;
        const departmentName = this.dataset.name;
        document.getElementById('assignDeptId').value = departmentId;
        document.getElementById('assignDeptName').innerText = departmentName;
        // 현재 부서 옵션 업데이트
        document.getElementById('currentDeptName').innerText = departmentName;
        // 초기 필터 설정: 현재 부서로 설정
        document.getElementById('filterDepartment').value = 'current';
        document.getElementById('filterType').value = '';
        document.getElementById('filterCategory').value = '';
        
        // 모달 열기
        assignQuestionsModalInstance.show();
        
        // 모달이 완전히 열린 후 부서 필터 옵션 업데이트 및 문제 렌더링
        setTimeout(() => {
            updateDepartmentFilterOptionsForModal(departmentId);
            renderQuestions();
            // 저장 버튼 이벤트 리스너 재등록
            attachSaveButtonListener();
        }, 100);
        
        // 모달이 열린 후 전체선택 버튼 클릭
        setTimeout(() => {
            document.getElementById('selectAllQuestions').click();
        }, 200);
    }
    
    // 저장 버튼 이벤트 리스너 연결 함수
    function attachSaveButtonListener() {
        const saveBtn = document.getElementById('saveAssignQuestionsBtn');
        if (saveBtn) {
            // 기존 이벤트 리스너 제거
            saveBtn.removeEventListener('click', handleSaveAssignQuestions);
            // 새로운 이벤트 리스너 추가
            saveBtn.addEventListener('click', handleSaveAssignQuestions);
        }
    }
    
    // 저장 버튼 클릭 핸들러
    function handleSaveAssignQuestions() {
        console.log('저장 버튼 클릭됨');
        
        // 부서 ID 확인
        const departmentId = document.getElementById('assignDeptId').value;
        if (!departmentId) {
            alert('부서 정보가 없습니다.');
            return;
        }
        
        // 모든 체크박스 상태 확인
        const allCheckboxes = document.querySelectorAll('.question-checkbox');
        console.log('전체 체크박스 개수:', allCheckboxes.length);
        
        // 선택된 문제 ID들 수집 (활성화된 체크박스 중에서만)
        const selectedQuestions = [];
        allCheckboxes.forEach((checkbox, index) => {
            console.log(`체크박스 ${index}:`, {
                id: checkbox.id,
                value: checkbox.value,
                checked: checkbox.checked,
                disabled: checkbox.disabled
            });
            
            // 활성화된 체크박스 중에서 체크된 것만 수집
            if (!checkbox.disabled && checkbox.checked) {
                selectedQuestions.push(checkbox.value);
            }
        });
        
        console.log('선택된 문제들:', selectedQuestions);
        console.log('부서 ID:', departmentId);
        
        // 현재 필터 조건 수집
        const filterConditions = {
            department: document.getElementById('filterDepartment').value,
            category: document.getElementById('filterCategory').value,
            type: document.getElementById('filterType').value
        };
        
        // 선택된 문제가 없어도 저장 가능 (모든 문제 해제하는 경우)
        const data = {
            department_id: departmentId,
            question_ids: selectedQuestions,
            filter_conditions: filterConditions
        };
        
        console.log('전송할 데이터:', data);
        console.log('필터 조건:', filterConditions);

        // 저장 버튼 비활성화 (중복 클릭 방지)
        const saveBtn = document.getElementById('saveAssignQuestionsBtn');
        saveBtn.disabled = true;
        saveBtn.textContent = '저장 중...';

        fetch(`/admin/departments/assign_questions`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(response => {
            console.log('응답 상태:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(result => {
            console.log('응답 결과:', result);
            if (result.success) {
                alert('문제 할당이 성공적으로 업데이트되었습니다.');
                assignQuestionsModalInstance.hide();
                // 부서 목록 업데이트
                updateDepartmentList();
                // 문제 데이터 다시 로드하여 실시간 업데이트
                loadQuestionsData();
            } else {
                alert('문제 할당 실패: ' + (result.message || '알 수 없는 오류가 발생했습니다.'));
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('문제 할당 중 오류가 발생했습니다: ' + error.message);
        }).finally(() => {
            // 저장 버튼 다시 활성화
            saveBtn.disabled = false;
            saveBtn.textContent = '저장';
        });
    }

    // =========================
    // 문제할당 모달 문제 렌더링
    // =========================
    // 모든 문제 데이터(백엔드에서 전달)
    let allQuestions = [];
    
    // 문제 데이터 로드 함수
    function loadQuestionsData() {
        fetch('/api/questions')
            .then(response => response.json())
            .then(data => {
                allQuestions = data;
                console.log('문제 데이터 다시 로드됨:', allQuestions.length);
                // 문제 목록 다시 렌더링
                renderQuestions();
            })
            .catch(error => {
                console.error('문제 데이터 로드 오류:', error);
            });
    }
    
    // 초기 문제 데이터 로드
    try {
        allQuestions = JSON.parse('{{ questions|tojson|safe }}');
        console.log('초기 로드된 문제 수:', allQuestions.length);
    } catch (error) {
        console.error('문제 데이터 파싱 오류:', error);
        allQuestions = [];
    }
    
    // 모달 관련 요소들
    const assignQuestionsModal = document.getElementById('assignQuestionsModal');
    const filterDepartment = document.getElementById('filterDepartment');
    const filterType = document.getElementById('filterType');
    const filterCategory = document.getElementById('filterCategory');
    const selectAllBtn = document.getElementById('selectAllQuestions');
    const deselectAllBtn = document.getElementById('deselectAllQuestions');
    
    // Bootstrap 모달 인스턴스 생성
    const assignQuestionsModalInstance = new bootstrap.Modal(assignQuestionsModal);
    
    // 부서명 가져오기 함수
    function getDepartmentName(departmentId) {
        // 부서 목록에서 해당 ID의 부서명 찾기
        const deptList = JSON.parse('{{ departments|tojson|safe }}');
        const dept = deptList.find(d => d.id === departmentId);
        return dept ? dept.name : '알 수 없는 부서';
    }

    // 문제 리스트와 상세 표시 함수
    function renderQuestions() {
        const deptId = document.getElementById('assignDeptId').value;
        const type = filterType.value;
        const category = filterCategory.value;
        const questionsContainer = document.getElementById('assignQuestionsContainer');
        questionsContainer.innerHTML = ''; // 기존 문제 목록 초기화
        
        // 필터 조건에 맞는 문제만 표시
        const filtered = allQuestions.filter(q => {
            // 부서 필터 로직
            let deptMatch = true;
            if (filterDepartment.value === '') {
                // 전체 부서: 모든 문제 표시
                deptMatch = true;
            } else if (filterDepartment.value === 'unassigned') {
                // 미지정 필터: 미지정 문제만
                deptMatch = (!q.department_ids || q.department_ids.length === 0);
            } else if (filterDepartment.value === 'current') {
                // 현재 부서 필터: 해당 부서 문제만
                deptMatch = (q.department_ids && q.department_ids.includes(deptId));
            } else {
                // 특정 부서 필터: 해당 부서 문제만
                deptMatch = (q.department_ids && q.department_ids.includes(filterDepartment.value));
            }
            
            const typeMatch = !type || q.type === type;
            const categoryMatch = !category || q.category === category;
            return deptMatch && typeMatch && categoryMatch;
        });
        
        // 조회된 문제 개수 표시
        document.getElementById('assignQuestionsCount').innerText = `조회된 문제: ${filtered.length}개`;
        
        if (filtered.length === 0) {
            questionsContainer.innerHTML = '<div class="text-muted">조건에 맞는 문제가 없습니다.</div>';
            return;
        }
        // 문제 카드 렌더링
        filtered.forEach((q, idx) => {
            const deptId = document.getElementById('assignDeptId').value;
            const isAssigned = (q.department_ids && q.department_ids.includes(deptId));
            const hasOtherDepartments = q.department_ids && q.department_ids.length > 0 && q.department_ids.some(id => id !== deptId);
            const isOnlyOtherDepartments = hasOtherDepartments && !isAssigned; // 다른 부서에만 할당된 경우
            
            // 카드 스타일 결정
            let cardClass = 'card mb-2';
            if (isAssigned) {
                cardClass += ' bg-light';
            }
            if (isOnlyOtherDepartments) {
                cardClass += ' border-info';
            }
            
            // 체크박스 상태 결정
            let checkboxChecked = '';
            let checkboxDisabled = '';
            let checkboxLabel = '할당';
            
            if (isAssigned) {
                // 현재 부서에 할당된 경우: 체크박스 활성화, 체크됨
                checkboxChecked = 'checked';
                checkboxLabel = '할당됨';
            } else if (isOnlyOtherDepartments) {
                // 다른 부서에만 할당된 경우: 체크박스 활성화, 체크 안됨 (할당 가능)
                checkboxChecked = '';
                checkboxLabel = '다른 부서 문제 (할당 가능)';
            }
            
            // 다른 부서에 할당된 부서명들 표시
            const otherDepartments = q.department_ids ? q.department_ids.filter(id => id !== deptId) : [];
            const otherDeptBadges = otherDepartments.map(id => `<span class="badge bg-info">${getDepartmentName(id)}</span>`).join('');
            
            const card = document.createElement('div');
            card.className = cardClass;
            card.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">${q.question}</h6>
                            <p class="card-text small text-muted">
                                <span class="badge bg-primary">${q.category}</span>
                                <span class="badge bg-secondary">${q.type}</span>
                                <span class="badge bg-info">${q.difficulty}</span>
                                <span class="badge bg-success">${q.points || ''}점</span>
                                ${isAssigned ? '<span class="badge bg-warning">현재 부서 할당됨</span>' : ''}
                                ${isOnlyOtherDepartments ? '<span class="badge bg-info">다른 부서 문제</span>' : ''}
                                ${otherDeptBadges}
                            </p>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input question-checkbox" type="checkbox" value="${q.id}" id="qcb_${q.id}" ${checkboxChecked} ${checkboxDisabled}>
                            <label class="form-check-label" for="qcb_${q.id}">${checkboxLabel}</label>
                        </div>
                    </div>
                    ${q.type === '객관식' ? `
                        <ul class="list-unstyled small text-muted mt-2">
                            ${q.options ? q.options.map((opt, i) => `<li>${i+1}. ${opt}</li>`).join('') : ''}
                        </ul>
                        <p class="small text-success mt-1">정답: ${q.correct_answer}</p>
                    ` : `
                        <p class="small text-success mt-1">정답 예시: ${q.correct_answer}</p>
                        ${q.keywords && q.keywords.length > 0 ? `
                            <p class="small text-muted mt-1">채점 키워드:</p>
                            <div class="ms-3">
                                ${q.keywords.map(kw => `<span class="badge bg-light text-dark me-1">${kw}</span>`).join('')}
                            </div>
                        ` : ''}
                    `}
                </div>
            `;
            questionsContainer.appendChild(card);
        });
    }

    // 초기 부서 목록 업데이트 (부서 필터 옵션 초기화)
    updateDepartmentList();
    
    // 초기 문제할당 버튼 이벤트 리스너 연결
    attachAssignQuestionsListeners();
    
    // 초기 저장 버튼 이벤트 리스너 연결
    attachSaveButtonListener();
    
    // 모달 닫기 버튼 이벤트 리스너 추가
    document.querySelectorAll('[data-bs-dismiss="modal"]').forEach(button => {
        button.addEventListener('click', function() {
            console.log('모달 닫기 버튼 클릭됨');
        });
    });
    // 필터 변경 시 렌더링
    filterDepartment.addEventListener('change', renderQuestions);
    filterType.addEventListener('change', renderQuestions);
    filterCategory.addEventListener('change', renderQuestions);
    // 전체선택/전체해제
    selectAllBtn.addEventListener('click', function() {
        // 활성화된 체크박스만 선택
        document.querySelectorAll('.question-checkbox:not(:disabled)').forEach(cb => cb.checked = true);
    });
    deselectAllBtn.addEventListener('click', function() {
        // 활성화된 체크박스만 해제
        document.querySelectorAll('.question-checkbox:not(:disabled)').forEach(cb => cb.checked = false);
    });



    // 랜덤 출제 개수 설정 불러오기
    fetch('/api/random_config')
        .then(res => res.json())
        .then(cfg => {
            // 기존 설정값이 있으면 사용, 없으면 기본값 사용
            document.getElementById('javaMcCountInput').value = cfg.java_mc_count || 2;
            document.getElementById('javaSubCountInput').value = cfg.java_sub_count || 1;
            document.getElementById('dbMcCountInput').value = cfg.db_mc_count || 3;
            document.getElementById('dbSubCountInput').value = cfg.db_sub_count || 1;
            document.getElementById('psMcCountInput').value = cfg.ps_mc_count || 3;
        });
    // 저장 이벤트
    document.getElementById('randomConfigForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        
        fetch('/api/random_config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                java_mc_count: parseInt(data.java_mc_count),
                java_sub_count: parseInt(data.java_sub_count),
                db_mc_count: parseInt(data.db_mc_count),
                db_sub_count: parseInt(data.db_sub_count),
                ps_mc_count: parseInt(data.ps_mc_count)
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // 성공 팝업 표시
                alert('랜덤 출제 설정이 성공적으로 저장되었습니다!');
                document.getElementById('randomConfigMsg').innerText = '저장되었습니다!';
                document.getElementById('randomConfigMsg').className = 'mt-1 text-success';
            } else {
                alert('저장 실패: ' + (data.message || '알 수 없는 오류가 발생했습니다.'));
                document.getElementById('randomConfigMsg').innerText = '저장 실패';
                document.getElementById('randomConfigMsg').className = 'mt-1 text-danger';
            }
            setTimeout(() => { 
                document.getElementById('randomConfigMsg').innerText = ''; 
                document.getElementById('randomConfigMsg').className = 'mt-1';
            }, 2000);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('저장 중 오류가 발생했습니다: ' + error.message);
            document.getElementById('randomConfigMsg').innerText = '저장 중 오류가 발생했습니다.';
            document.getElementById('randomConfigMsg').className = 'mt-1 text-danger';
            setTimeout(() => { 
                document.getElementById('randomConfigMsg').innerText = ''; 
                document.getElementById('randomConfigMsg').className = 'mt-1';
            }, 2000);
        });
    });

    // OpenAI API Key 저장
    const openaiKeyForm = document.getElementById('openaiKeyForm');
    openaiKeyForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const key = document.getElementById('openaiApiKeyInput').value.trim();
        if (!key) {
            alert('API Key를 입력하세요.');
            return;
        }
        fetch('/admin/openai_key', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ openai_api_key: key })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert('API Key가 저장되었습니다.');
                document.getElementById('openaiApiKeyInput').value = '';
                var modal = bootstrap.Modal.getInstance(document.getElementById('openaiKeyModal'));
                modal.hide();
            } else {
                alert('저장 실패: ' + data.message);
            }
        })
        .catch(() => {
            alert('저장 중 오류가 발생했습니다.');
        });
    });
});
</script>
{% endblock %}